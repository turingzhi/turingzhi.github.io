<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Missing Semester Lecture7: Debugging and Profiling, Hexo">
    <meta name="description" content="Lecture 7: Debugging and Profilinglink:https://missing.csail.mit.edu/2020/debugging-profiling/
Printf debugging and Logg">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Missing Semester Lecture7: Debugging and Profiling | Hexo</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Hexo</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Hexo</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/6.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Missing Semester Lecture7: Debugging and Profiling</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/debug/">
                                <span class="chip bg-color">debug</span>
                            </a>
                        
                            <a href="/tags/profiling/">
                                <span class="chip bg-color">profiling</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/missing-semester/" class="post-category">
                                missing semester
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2024-07-11
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>Update Date:&nbsp;&nbsp;
                    2024-08-19
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    5.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>Read Times:&nbsp;&nbsp;
                    34 Min
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>Read Count:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h4 id="Lecture-7-Debugging-and-Profiling"><a href="#Lecture-7-Debugging-and-Profiling" class="headerlink" title="Lecture 7: Debugging and Profiling"></a>Lecture 7: Debugging and Profiling</h4><p>link:<a target="_blank" rel="noopener" href="https://missing.csail.mit.edu/2020/debugging-profiling/">https://missing.csail.mit.edu/2020/debugging-profiling/</a></p>
<h3 id="Printf-debugging-and-Logging"><a href="#Printf-debugging-and-Logging" class="headerlink" title="Printf debugging and Logging"></a>Printf debugging and Logging</h3><ul>
<li>A first approach to debug a program is to add print statements around where you have detected the problem, and keep iterating until you have extracted enough information to understand what is responsible for the issue.</li>
<li>A second approach is to use logging in your program, instead of ad hoc print statements. Logging is better than regular print statements for several reasons:<ul>
<li>You can log to files, sockets or even remote servers instead of standard output.</li>
<li>Logging supports severity levels (such as INFO, DEBUG, WARN, ERROR, &amp;c), that allow you to filter the output accordingly.</li>
<li>For new issues, there’s a fair chance that your logs will contain enough information to detect what is going wrong.</li>
</ul>
</li>
</ul>
<pre><code class="lang-bash">$ python logger.py
# Raw output as with just prints
$ python logger.py log
# Log formatted output
$ python logger.py log ERROR
# Print only ERROR levels and above
$ python logger.py color
# Color formatted output
</code></pre>
<blockquote>
<p>The most important way of making logs more readable is to color code them. By now you probably have realized that your terminal uses colors to make things more readable. But how does it do it? Programs like <code>ls</code> or <code>grep</code> are using <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/ANSI_escape_code">ANSI escape codes</a>, which are special sequences of characters to indicate your shell to change the color of the output. For example, executing <code>echo -e "\e[38;2;255;0;0mThis is red\e[0m"</code> prints the message <code>This is red</code>in red on your terminal, as long as it supports <a target="_blank" rel="noopener" href="https://github.com/termstandard/colors#truecolor-support-in-output-devices">true color</a>. If your terminal doesn’t support this (e.g. macOS’s Terminal.app), you can use the more universally supported escape codes for 16 color choices, for example <code>echo -e "\e[31;1mThis is red\e[0m"</code>.</p>
</blockquote>
<h3 id="Third-party-logs"><a href="#Third-party-logs" class="headerlink" title="Third party logs"></a>Third party logs</h3><blockquote>
<p>most programs write their own logs somewhere in your system. In UNIX systems, it is commonplace for programs to write their logs under <code>/var/log</code>. For instance, the <a target="_blank" rel="noopener" href="https://www.nginx.com/">NGINX</a> webserver places its logs under <code>/var/log/nginx</code>. </p>
<p>More recently, systems have started using a <strong>system log</strong>, which is increasingly where all of your log messages go. Most (but not all) Linux systems use <code>systemd</code>, a system daemon that controls many things in your system such as which services are enabled and running. <code>systemd</code> places the logs under <code>/var/log/journal</code> in a specialized format and you can use the <a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man1/journalctl.1.html"><code>journalctl</code></a>command to display the messages. </p>
<p>Similarly, on macOS there is still <code>/var/log/system.log</code> but an increasing number of tools use the system log, that can be displayed with <a target="_blank" rel="noopener" href="https://www.manpagez.com/man/1/log/"><code>log show</code></a>. </p>
<p>On most UNIX systems you can also use the <a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man1/dmesg.1.html"><code>dmesg</code></a> command to access the kernel log.</p>
<p>For logging under the system logs you can use the <a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man1/logger.1.html"><code>logger</code></a> shell program. Here’s an example of using <code>logger</code> and how to check that the entry made it to the system logs. Moreover, most programming languages have bindings logging to the system log.</p>
</blockquote>
<pre><code class="lang-bash">logger "Hello Logs"
# On macOS
log show --last 1m | grep Hello
# On Linux
journalctl --since "1m ago" | grep Hello
</code></pre>
<h3 id="Debugger"><a href="#Debugger" class="headerlink" title="Debugger"></a>Debugger</h3><p>When printf debugging is not enough you should use a debugger. Debuggers are programs that let you interact with the execution of a program, allowing the following:</p>
<ul>
<li>Halt execution of the program when it reaches a certain line.</li>
<li>Step through the program one instruction at a time.</li>
<li>Inspect values of variables after the program crashed.</li>
<li>Conditionally halt the execution when a given condition is met.</li>
<li>And many more advanced features</li>
</ul>
<p>Many programming languages come with some form of debugger. In Python this is the Python Debugger <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/pdb.html"><code>pdb</code></a>.</p>
<p>Here is a brief description of some of the commands <code>pdb</code> supports:</p>
<ul>
<li><strong>l</strong>(ist) - Displays 11 lines around the current line or continue the previous listing.</li>
<li><strong>s</strong>(tep) - Execute the current line, stop at the first possible occasion.</li>
<li><strong>n</strong>(ext) - Continue execution until the next line in the current function is reached or it returns.</li>
<li><strong>b</strong>(reak) - Set a breakpoint (depending on the argument provided).</li>
<li><strong>p</strong>(rint) - Evaluate the expression in the current context and print its value. There’s also <strong>pp</strong> to display using <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/pprint.html"><code>pprint</code></a> instead.</li>
<li><strong>r</strong>(eturn) - Continue execution until the current function returns.</li>
<li><strong>q</strong>(uit) - Quit the debugger</li>
</ul>
<p>Note that since Python is an interpreted language we can use the <code>pdb</code> shell to execute commands and to execute instructions. <a target="_blank" rel="noopener" href="https://pypi.org/project/ipdb/"><code>ipdb</code></a> is an improved <code>pdb</code> that uses the <a target="_blank" rel="noopener" href="https://ipython.org/"><code>IPython</code></a> REPL enabling tab completion, syntax highlighting, better tracebacks, and better introspection while retaining the same interface as the <code>pdb</code> module.</p>
<p>For more low level programming you will probably want to look into <a target="_blank" rel="noopener" href="https://www.gnu.org/software/gdb/"><code>gdb</code></a> (and its quality of life modification <a target="_blank" rel="noopener" href="https://github.com/pwndbg/pwndbg"><code>pwndbg</code></a>) and <a target="_blank" rel="noopener" href="https://lldb.llvm.org/"><code>lldb</code></a>. They are optimized for C-like language debugging but will let you probe pretty much any process and get its current machine state: registers, stack, program counter, &amp;c.</p>
<h3 id="Specialized-Tools"><a href="#Specialized-Tools" class="headerlink" title="Specialized Tools"></a>Specialized Tools</h3><p>Even if what you are trying to debug is a black box binary there are tools that can help you with that. Whenever programs need to perform actions that only the kernel can, they use <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/System_call">System Calls</a>. There are commands that let you trace the syscalls your program makes. In Linux there’s <a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man1/strace.1.html"><code>strace</code></a> and macOS and BSD have <a target="_blank" rel="noopener" href="http://dtrace.org/blogs/about/"><code>dtrace</code></a>. <code>dtrace</code> can be tricky to use because it uses its own <code>D</code> language, but there is a wrapper called <a target="_blank" rel="noopener" href="https://www.manpagez.com/man/1/dtruss/"><code>dtruss</code></a> that provides an interface more similar to <code>strace</code> (more details <a target="_blank" rel="noopener" href="https://8thlight.com/blog/colin-jones/2015/11/06/dtrace-even-better-than-strace-for-osx.html">here</a>).</p>
<p>Below are some examples of using <code>strace</code> or <code>dtruss</code> to show <a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man2/stat.2.html"><code>stat</code></a> syscall traces for an execution of <code>ls</code>. For a deeper dive into <code>strace</code>, <a target="_blank" rel="noopener" href="https://blogs.oracle.com/linux/strace-the-sysadmins-microscope-v2">this article</a> and <a target="_blank" rel="noopener" href="https://jvns.ca/strace-zine-unfolded.pdf">this zine</a> are good reads.</p>
<pre><code class="lang-bash"># On Linux
sudo strace -e lstat ls -l &gt; /dev/null
# On macOS
sudo dtruss -t lstat64_extended ls -l &gt; /dev/null
</code></pre>
<p>Under some circumstances, you may need to look at the network packets to figure out the issue in your program. Tools like <a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man1/tcpdump.1.html"><code>tcpdump</code></a> and <a target="_blank" rel="noopener" href="https://www.wireshark.org/">Wireshark</a> are network packet analyzers that let you read the contents of network packets and filter them based on different criteria.</p>
<p>For web development, the Chrome/Firefox developer tools are quite handy. They feature a large number of tools, including:</p>
<ul>
<li>Source code - Inspect the HTML/CSS/JS source code of any website.</li>
<li>Live HTML, CSS, JS modification - Change the website content, styles and behavior to test (you can see for yourself that website screenshots are not valid proofs).</li>
<li>Javascript shell - Execute commands in the JS REPL.</li>
<li>Network - Analyze the requests timeline.</li>
<li>Storage - Look into the Cookies and local application storage.</li>
</ul>
<blockquote>
<p>For some issues you do not need to run any code. For example, just by carefully looking at a piece of code you could realize that your loop variable is shadowing an already existing variable or function name; or that a program reads a variable before defining it. Here is where <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Static_program_analysis">static analysis</a> tools come into play. Static analysis programs take source code as input and analyze it using coding rules to reason about its correctness.</p>
<p>In the following Python snippet there are several mistakes. First, our loop variable <code>foo</code> shadows the previous definition of the function <code>foo</code>. We also wrote <code>baz</code> instead of <code>bar</code> in the last line, so the program will crash after completing the <code>sleep</code> call (which will take one minute).</p>
</blockquote>
<pre><code class="lang-bash">import time

def foo():
    return 42

for foo in range(5):
    print(foo)
bar = 1
bar *= 0.2
time.sleep(60)
print(baz)
</code></pre>
<p>Static analysis tools can identify these kinds of issues. When we run <a target="_blank" rel="noopener" href="https://pypi.org/project/pyflakes"><code>pyflakes</code></a>on the code we get the errors related to both bugs. <a target="_blank" rel="noopener" href="http://mypy-lang.org/"><code>mypy</code></a> is another tool that can detect type checking issues. Here, <code>mypy</code> will warn us that <code>bar</code> is initially an <code>int</code> and is then casted to a <code>float</code>. Again, note that all these issues were detected without having to run the code.</p>
<pre><code class="lang-bash">$ pyflakes foobar.py
foobar.py:6: redefinition of unused 'foo' from line 3
foobar.py:11: undefined name 'baz'

$ mypy foobar.py
foobar.py:6: error: Incompatible types in assignment (expression has type "int", variable has type "Callable[[], Any]")
foobar.py:9: error: Incompatible types in assignment (expression has type "float", variable has type "int")
foobar.py:11: error: Name 'baz' is not defined
Found 3 errors in 1 file (checked 1 source file)
</code></pre>
<p>In the shell tools lecture we covered <a target="_blank" rel="noopener" href="https://www.shellcheck.net/"><code>shellcheck</code></a>, which is a similar tool for shell scripts.</p>
<p>Most editors and IDEs support displaying the output of these tools within the editor itself, highlighting the locations of warnings and errors. This is often called <strong>code linting</strong> and it can also be used to display other types of issues such as stylistic violations or insecure constructs.</p>
<p>In vim, the plugins <a target="_blank" rel="noopener" href="https://vimawesome.com/plugin/ale"><code>ale</code></a> or <a target="_blank" rel="noopener" href="https://vimawesome.com/plugin/syntastic"><code>syntastic</code></a> will let you do that. For Python, <a target="_blank" rel="noopener" href="https://github.com/PyCQA/pylint"><code>pylint</code></a>and <a target="_blank" rel="noopener" href="https://pypi.org/project/pep8/"><code>pep8</code></a> are examples of stylistic linters and <a target="_blank" rel="noopener" href="https://pypi.org/project/bandit/"><code>bandit</code></a> is a tool designed to find common security issues. For other languages people have compiled comprehensive lists of useful static analysis tools, such as <a target="_blank" rel="noopener" href="https://github.com/mre/awesome-static-analysis">Awesome Static Analysis</a> (you may want to take a look at the <em>Writing</em> section) and for linters there is <a target="_blank" rel="noopener" href="https://github.com/caramelomartins/awesome-linters">Awesome Linters</a>.</p>
<p>A complementary tool to stylistic linting are code formatters such as <a target="_blank" rel="noopener" href="https://github.com/psf/black"><code>black</code></a> for Python, <code>gofmt</code> for Go, <code>rustfmt</code> for Rust or <a target="_blank" rel="noopener" href="https://prettier.io/"><code>prettier</code></a> for JavaScript, HTML and CSS. These tools autoformat your code so that it’s consistent with common stylistic patterns for the given programming language. Although you might be unwilling to give stylistic control about your code, standardizing code format will help other people read your code and will make you better at reading other people’s (stylistically standardized) code.</p>
<h3 id="Profiling"><a href="#Profiling" class="headerlink" title="Profiling"></a>Profiling</h3><h4 id="Time"><a href="#Time" class="headerlink" title="Time"></a>Time</h4><p>Similarly to the debugging case, in many scenarios it can be enough to just print the time it took your code between two points. Here is an example in Python using the <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/time.html"><code>time</code></a> module.</p>
<pre><code class="lang-bash">import time, random
n = random.randint(1, 10) * 100

# Get current time
start = time.time()

# Do some work
print("Sleeping for {} ms".format(n))
time.sleep(n/1000)

# Compute time between start and now
print(time.time() - start)

# Output
# Sleeping for 500 ms
# 0.5713930130004883
</code></pre>
<p>However, wall clock time can be misleading since your computer might be running other processes at the same time or waiting for events to happen. It is common for tools to make a distinction between <em>Real</em>, <em>User</em> and <em>Sys</em> time. In general, <em>User</em> + <em>Sys</em> tells you how much time your process actually spent in the CPU (more detailed explanation <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/556405/what-do-real-user-and-sys-mean-in-the-output-of-time1">here</a>).</p>
<ul>
<li><em>Real</em> - Wall clock elapsed time from start to finish of the program, including the time taken by other processes and time taken while blocked (e.g. waiting for I/O or network)</li>
<li><em>User</em> - Amount of time spent in the CPU running user code</li>
<li><em>Sys</em> - Amount of time spent in the CPU running kernel code</li>
</ul>
<p>For example, try running a command that performs an HTTP request and prefixing it with <a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man1/time.1.html"><code>time</code></a>. Under a slow connection you might get an output like the one below. Here it took over 2 seconds for the request to complete but the process only took 15ms of CPU user time and 12ms of kernel CPU time.</p>
<pre><code class="lang-bash">$ time curl https://missing.csail.mit.edu &amp;&gt; /dev/null
real    0m2.561s
user    0m0.015s
sys     0m0.012s
</code></pre>
<h4 id="Profiler"><a href="#Profiler" class="headerlink" title="Profiler"></a>Profiler</h4><h4 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h4><p>Most of the time when people refer to <em>profilers</em> they actually mean <em>CPU profilers</em>, which are the most common. There are two main types of CPU profilers: <em>tracing</em>and <em>sampling</em> profilers. Tracing profilers keep a record of every function call your program makes whereas sampling profilers probe your program periodically (commonly every millisecond) and record the program’s stack. They use these records to present aggregate statistics of what your program spent the most time doing. <a target="_blank" rel="noopener" href="https://jvns.ca/blog/2017/12/17/how-do-ruby---python-profilers-work-">Here</a> is a good intro article if you want more detail on this topic.</p>
<p>Most programming languages have some sort of command line profiler that you can use to analyze your code. They often integrate with full fledged IDEs but for this lecture we are going to focus on the command line tools themselves.</p>
<p>In Python we can use the <code>cProfile</code> module to profile time per function call. Here is a simple example that implements a rudimentary grep in Python:</p>
<pre><code class="lang-bash">#!/usr/bin/env python

import sys, re

def grep(pattern, file):
    with open(file, 'r') as f:
        print(file)
        for i, line in enumerate(f.readlines()):
            pattern = re.compile(pattern)
            match = pattern.search(line)
            if match is not None:
                print("{}: {}".format(i, line), end="")

if __name__ == '__main__':
    times = int(sys.argv[1])
    pattern = sys.argv[2]
    for i in range(times):
        for file in sys.argv[3:]:
            grep(pattern, file)
</code></pre>
<p>We can profile this code using the following command. Analyzing the output we can see that IO is taking most of the time and that compiling the regex takes a fair amount of time as well. Since the regex only needs to be compiled once, we can factor it out of the for.</p>
<pre><code class="lang-bash">$ python -m cProfile -s tottime grep.py 1000 '^(import|\s*def)[^,]*$' *.py

[omitted program output]

 ncalls  tottime  percall  cumtime  percall filename:lineno(function)
     8000    0.266    0.000    0.292    0.000 {built-in method io.open}
     8000    0.153    0.000    0.894    0.000 grep.py:5(grep)
    17000    0.101    0.000    0.101    0.000 {built-in method builtins.print}
     8000    0.100    0.000    0.129    0.000 {method 'readlines' of '_io._IOBase' objects}
    93000    0.097    0.000    0.111    0.000 re.py:286(_compile)
    93000    0.069    0.000    0.069    0.000 {method 'search' of '_sre.SRE_Pattern' objects}
    93000    0.030    0.000    0.141    0.000 re.py:231(compile)
    17000    0.019    0.000    0.029    0.000 codecs.py:318(decode)
        1    0.017    0.017    0.911    0.911 grep.py:3(&lt;module&gt;)

[omitted lines]
</code></pre>
<p>A caveat of Python’s <code>cProfile</code> profiler (and many profilers for that matter) is that they display time per function call. That can become unintuitive really fast, especially if you are using third party libraries in your code since internal function calls are also accounted for. A more intuitive way of displaying profiling information is to include the time taken per line of code, which is what <em>line profilers</em> do.</p>
<p>For instance, the following piece of Python code performs a request to the class website and parses the response to get all URLs in the page:</p>
<pre><code class="lang-bash">#!/usr/bin/env python
import requests
from bs4 import BeautifulSoup

# This is a decorator that tells line_profiler
# that we want to analyze this function
@profile
def get_urls():
    response = requests.get('https://missing.csail.mit.edu')
    s = BeautifulSoup(response.content, 'lxml')
    urls = []
    for url in s.find_all('a'):
        urls.append(url['href'])

if __name__ == '__main__':
    get_urls()
</code></pre>
<p>If we used Python’s <code>cProfile</code> profiler we’d get over 2500 lines of output, and even with sorting it’d be hard to understand where the time is being spent. A quick run with <a target="_blank" rel="noopener" href="https://github.com/pyutils/line_profiler"><code>line_profiler</code></a> shows the time taken per line:</p>
<pre><code class="lang-bash">$ kernprof -l -v a.py
Wrote profile results to urls.py.lprof
Timer unit: 1e-06 s

Total time: 0.636188 s
File: a.py
Function: get_urls at line 5

Line #  Hits         Time  Per Hit   % Time  Line Contents
==============================================================
 5                                           @profile
 6                                           def get_urls():
 7         1     613909.0 613909.0     96.5      response = requests.get('https://missing.csail.mit.edu')
 8         1      21559.0  21559.0      3.4      s = BeautifulSoup(response.content, 'lxml')
 9         1          2.0      2.0      0.0      urls = []
10        25        685.0     27.4      0.1      for url in s.find_all('a'):
11        24         33.0      1.4      0.0          urls.append(url['href'])
</code></pre>
<h4 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h4><p>In languages like C or C++ memory leaks can cause your program to never release memory that it doesn’t need anymore. To help in the process of memory debugging you can use tools like <a target="_blank" rel="noopener" href="https://valgrind.org/">Valgrind</a> that will help you identify memory leaks.</p>
<p>In garbage collected languages like Python it is still useful to use a memory profiler because as long as you have pointers to objects in memory they won’t be garbage collected. Here’s an example program and its associated output when running it with <a target="_blank" rel="noopener" href="https://pypi.org/project/memory-profiler/">memory-profiler</a> (note the decorator like in <code>line-profiler</code>).</p>
<pre><code class="lang-bash">@profile
def my_func():
    a = [1] * (10 ** 6)
    b = [2] * (2 * 10 ** 7)
    del b
    return a

if __name__ == '__main__':
    my_func()
$ python -m memory_profiler example.py
Line #    Mem usage  Increment   Line Contents
==============================================
     3                           @profile
     4      5.97 MB    0.00 MB   def my_func():
     5     13.61 MB    7.64 MB       a = [1] * (10 ** 6)
     6    166.20 MB  152.59 MB       b = [2] * (2 * 10 ** 7)
     7     13.61 MB -152.59 MB       del b
     8     13.61 MB    0.00 MB       return a
</code></pre>
<h3 id="Visualization"><a href="#Visualization" class="headerlink" title="Visualization"></a>Visualization</h3><p>Profiler output for real world programs will contain large amounts of information because of the inherent complexity of software projects. Humans are visual creatures and are quite terrible at reading large amounts of numbers and making sense of them. Thus there are many tools for displaying profiler’s output in an easier to parse way.</p>
<p>One common way to display CPU profiling information for sampling profilers is to use a <a target="_blank" rel="noopener" href="http://www.brendangregg.com/flamegraphs.html">Flame Graph</a>, which will display a hierarchy of function calls across the Y axis and time taken proportional to the X axis. They are also interactive, letting you zoom into specific parts of the program and get their stack traces (try clicking in the image below).</p>
<p><img src="http://www.brendangregg.com/FlameGraphs/cpu-bash-flamegraph.svg" alt=""></p>
<p>Call graphs or control flow graphs display the relationships between subroutines within a program by including functions as nodes and functions calls between them as directed edges. When coupled with profiling information such as the number of calls and time taken, call graphs can be quite useful for interpreting the flow of a program. In Python you can use the <a target="_blank" rel="noopener" href="https://pycallgraph.readthedocs.io/"><code>pycallgraph</code></a>library to generate them.</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/2/2f/A_Call_Graph_generated_by_pycallgraph.png" alt=""></p>
<h4 id="Resource-Monitoring"><a href="#Resource-Monitoring" class="headerlink" title="Resource Monitoring"></a>Resource Monitoring</h4><p>Sometimes, the first step towards analyzing the performance of your program is to understand what its actual resource consumption is. Programs often run slowly when they are resource constrained, e.g. without enough memory or on a slow network connection. There are a myriad of command line tools for probing and displaying different system resources like CPU usage, memory usage, network, disk usage and so on.</p>
<ul>
<li><strong>General Monitoring</strong> - Probably the most popular is <a target="_blank" rel="noopener" href="https://htop.dev/"><code>htop</code></a>, which is an improved version of <a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man1/top.1.html"><code>top</code></a>. <code>htop</code> presents various statistics for the currently running processes on the system. <code>htop</code> has a myriad of options and keybinds, some useful ones are: <code>&lt;F6&gt;</code> to sort processes, <code>t</code> to show tree hierarchy and <code>h</code> to toggle threads. See also <a target="_blank" rel="noopener" href="https://nicolargo.github.io/glances/"><code>glances</code></a> for similar implementation with a great UI. For getting aggregate measures across all processes, <a target="_blank" rel="noopener" href="http://dag.wiee.rs/home-made/dstat/"><code>dstat</code></a> is another nifty tool that computes real-time resource metrics for lots of different subsystems like I/O, networking, CPU utilization, context switches, &amp;c.</li>
<li><strong>I/O operations</strong> - <a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man8/iotop.8.html"><code>iotop</code></a> displays live I/O usage information and is handy to check if a process is doing heavy I/O disk operations</li>
<li><strong>Disk Usage</strong> - <a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man1/df.1.html"><code>df</code></a> displays metrics per partitions and <a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man1/du.1.html"><code>du</code></a> displays <strong>d</strong>isk <strong>u</strong>sage per file for the current directory. In these tools the <code>-h</code> flag tells the program to print with <strong>h</strong>uman readable format. A more interactive version of <code>du</code> is <a target="_blank" rel="noopener" href="https://dev.yorhel.nl/ncdu"><code>ncdu</code></a> which lets you navigate folders and delete files and folders as you navigate.</li>
<li><strong>Memory Usage</strong> - <a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man1/free.1.html"><code>free</code></a> displays the total amount of free and used memory in the system. Memory is also displayed in tools like <code>htop</code>.</li>
<li><strong>Open Files</strong> - <a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man8/lsof.8.html"><code>lsof</code></a> lists file information about files opened by processes. It can be quite useful for checking which process has opened a specific file.</li>
<li><strong>Network Connections and Config</strong> - <a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man8/ss.8.html"><code>ss</code></a> lets you monitor incoming and outgoing network packets statistics as well as interface statistics. A common use case of <code>ss</code> is figuring out what process is using a given port in a machine. For displaying routing, network devices and interfaces you can use <a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man8/ip.8.html"><code>ip</code></a>. Note that <code>netstat</code> and <code>ifconfig</code> have been deprecated in favor of the former tools respectively.</li>
<li><strong>Network Usage</strong> - <a target="_blank" rel="noopener" href="https://github.com/raboof/nethogs"><code>nethogs</code></a> and <a target="_blank" rel="noopener" href="http://www.ex-parrot.com/pdw/iftop/"><code>iftop</code></a> are good interactive CLI tools for monitoring network usage.</li>
</ul>
<p>If you want to test these tools you can also artificially impose loads on the machine using the <a target="_blank" rel="noopener" href="https://linux.die.net/man/1/stress"><code>stress</code></a> command.</p>
<h4 id="Specialized-tools"><a href="#Specialized-tools" class="headerlink" title="Specialized tools"></a>Specialized tools</h4><p>Sometimes, black box benchmarking is all you need to determine what software to use. Tools like <a target="_blank" rel="noopener" href="https://github.com/sharkdp/hyperfine"><code>hyperfine</code></a> let you quickly benchmark command line programs. For instance, in the shell tools and scripting lecture we recommended <code>fd</code> over <code>find</code>. We can use <code>hyperfine</code> to compare them in tasks we run often. E.g. in the example below <code>fd</code> was 20x faster than <code>find</code> in my machine.</p>
<pre><code class="lang-bash">$ hyperfine --warmup 3 'fd -e jpg' 'find . -iname "*.jpg"'
Benchmark #1: fd -e jpg
  Time (mean ± σ):      51.4 ms ±   2.9 ms    [User: 121.0 ms, System: 160.5 ms]
  Range (min … max):    44.2 ms …  60.1 ms    56 runs

Benchmark #2: find . -iname "*.jpg"
  Time (mean ± σ):      1.126 s ±  0.101 s    [User: 141.1 ms, System: 956.1 ms]
  Range (min … max):    0.975 s …  1.287 s    10 runs

Summary
  'fd -e jpg' ran
   21.89 ± 2.33 times faster than 'find . -iname "*.jpg"'
</code></pre>
<p>As it was the case for debugging, browsers also come with a fantastic set of tools for profiling webpage loading, letting you figure out where time is being spent (loading, rendering, scripting, &amp;c). More info for <a target="_blank" rel="noopener" href="https://profiler.firefox.com/docs/">Firefox</a> and <a target="_blank" rel="noopener" href="https://developers.google.com/web/tools/chrome-devtools/rendering-tools">Chrome</a>.</p>
<p><strong>Shellcheck</strong></p>
<p><strong>PDB</strong></p>
<p><a target="_blank" rel="noopener" href="https://wil.yegelwel.com/pdb-pm/">https://wil.yegelwel.com/pdb-pm/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/spiside/pdb-tutorial">https://github.com/spiside/pdb-tutorial</a></p>
<blockquote>
<p><code>l(ist)</code> <code>ll(long list)</code>ll shows  you source code for the current function or frame. It’s much better knowing which function you are in than an arbitrary 11 lines around your current position.</p>
<pre><code class="lang-bash">(Pdb) l
  4     def main():
  5         print("Add the values of the dice")
  6         print("It's really that easy")
  7         print("What are you doing with your life.")
  8         import pdb; pdb.set_trace()
  9  -&gt;     GameRunner.run()
 10     
 11     
 12     if __name__ == "__main__":
 13         main()
[EOF]
</code></pre>
<p>If we want to see the whole file, we can call the list function with the range 1 to 13 like so:</p>
<pre><code class="lang-bash">(Pdb) l 1, 13
  1     from dicegame.runner import GameRunner
  2     
  3     
  4     def main():
  5         print("Add the values of the dice")
  6         print("It's really that easy")
  7         print("What are you doing with your life.")
  8         import pdb; pdb.set_trace()
  9  -&gt;     GameRunner.run()
 10     
 11     
 12     if __name__ == "__main__":
 13         main()
</code></pre>
<p><code>s(tep)</code>  Execute the current line, stop at the first possible occasion(either in a function that is called or in the current function).</p>
<pre><code class="lang-bash">(Pdb) s
--Call--
&gt; /Users/Development/pdb-tutorial/dicegame/runner.py(21)run()
-&gt; @classmethod
</code></pre>
<pre><code class="lang-bash">(Pdb) l
 16             total = 0
 17             for die in self.dice:
 18                 total += 1
 19             return total
 20     
 21  -&gt;     @classmethod
 22         def run(cls):
 23             # Probably counts wins or something.
 24             # Great variable name, 10/10.
 25             c = 0
 26             while True:
</code></pre>
<p><code>n(ext)</code>  Continue execution until the next line in the current function is reached or it returns.</p>
<pre><code class="lang-bash">(Pdb) n
&gt; /Users/Development/pdb-tutorial/dicegame/runner.py(27)run()
-&gt; while True:
(Pdb) l
 21         @classmethod
 22         def run(cls):
 23             # Probably counts wins or something.
 24             # Great variable name, 10/10.
 25             c = 0
 26  -&gt;         while True:
 27                 runner = cls()
 28     
 29                 print("Round {}\n".format(runner.round))
 30     
 31                 for die in runner.dice:
</code></pre>
<p><code>b(reak)</code> </p>
<ul>
<li>Without argument, list all breaks.</li>
<li><p>With a line number argument, set a break at this line in the current file. With a function name, set a break at the first executable line of that function. If a second argument is present, it is a string specifying an expression which must evaluate to true before the breakpoint is honored.</p>
</li>
<li><p>The line number may be prefixed with a filename and a colon, to specify a breakpoint in another file (probably one that hasn’t been loaded yet).  The file is searched for on sys.path; the .py suffix may be omitted.</p>
</li>
</ul>
<pre><code class="lang-bash">(Pdb) b 34
Breakpoint 1 at /Users/Development/pdb-tutorial/dicegame/runner.py(34)run()
(Pdb) c

[...] # prints some dice

&gt; /Users/Development/pdb-tutorial/dicegame/runner.py(34)run()
-&gt; guess = input("Sigh. What is your guess?: ")
</code></pre>
<pre><code class="lang-bash">(Pdb) b
Num Type         Disp Enb   Where
1   breakpoint   keep yes   at /Users/Development/pdb-tutorial/dicegame/runner.py:34
    breakpoint already hit 1 time
</code></pre>
<p><code>cl(ear)</code> To clear your break points, you can use the <code>cl(ear)</code> command followed by the breakpoint number which is found in the leftmost column of the above output. You can also clear all the breakpoints if you don’t provide any arguments to the <code>clear</code> command.</p>
<pre><code class="lang-bash">(Pdb) cl 1
Deleted breakpoint 1 at /Users/Development/pdb-tutorial/dicegame/runner.py:34
</code></pre>
<p><code>r(eturn)</code>  Continue execution until the current function returns.</p>
<pre><code class="lang-bash">(Pdb) r
--Return--
&gt; /Users/Development/pdb-tutorial/dicegame/runner.py(19)answer()-&gt;5
-&gt; return total
(Pdb) l
 14     
 15         def answer(self):
 16             total = 0
 17             for die in self.dice:
 18                 total += 1
 19  -&gt;         return total
 20     
 21         @classmethod
 22         def run(cls):
 23             # Probably counts wins or something.
 24             # Great variable name, 10/10.
(Pdb)
</code></pre>
<p><code>continue</code> The <code>continue</code> command instructs the debugger to resume execution of the program until the next breakpoint is encountered, an exception is raised, or the program terminates.</p>
<p><code>!c</code> If there is a variable called. c, but this c maybe be misunderstood with c(ontinue). So we use <code>!c</code> to get the value of variable c</p>
<pre><code class="lang-bash"> (Pdb) !c
 0
</code></pre>
<p><code>commands</code></p>
<pre><code class="lang-bash">commands [bpnumber]
        (com) ...
        (com) end
        (Pdb)

Specify a list of commands for breakpoint number bpnumber.
</code></pre>
<p><code>commands</code> will run python code or pdb commands that you specified whenever the stated breakpoint number is hit. Once you start the <code>commands</code> block, the prompt changes to <code>(com)</code>. The code/commands you write here function as if you had typed them at the <code>(Pdb)</code> prompt after getting to that breakpoint. Writing <code>end</code> will terminate the command and the prompt changes back to <code>(Pdb)</code> from <code>(com)</code>. I have found this of great use when I need to monitor certain variables inside of a loop as I don’t need to print the values of the variables repeatedly. Let’s see an example. Make sure to be at the root of the project in your terminal and type the following:</p>
<pre><code class="lang-bash">python -m pdb main.py
</code></pre>
<p>Reach line <code>:8</code> and <code>s(tep)</code> into the <code>run()</code> method of the GameRunner class. Then, set up a breakpoint at <code>:17</code>.</p>
<pre><code class="lang-bash">&gt; /Users/Development/pdb-tutorial/main.py(8)main()
-&gt; GameRunner.run()  #This is line 8 in main.py
(Pdb) s      
--Call--
&gt; /Users/Development/pdb-tutorial/dicegame/runner.py(21)run()
-&gt; @classmethod 
(Pdb) b 17
Breakpoint 4 at /Users/Development/pdb-tutorial/dicegame/runner.py:17
</code></pre>
<p>This sets up the breakpoint, which has been given the number <code>4</code>, at the start of the loop inside the <code>answer()</code>method which is used to calculate the total values of the dice. Now, let’s us use <code>commands</code> to print the value of the variable <code>total</code> when we hit this breakpoint.</p>
<pre><code class="lang-bash">(Pdb) commands 4
(com) print(f"The total value as of now is {total}")
(com) end
</code></pre>
<p>We have now set up <code>commands</code> for breakpoint number 4 which will execute when we reach this breakpoint. Let us <code>c(ontinue)</code> and reach this breakpoint.</p>
<pre><code class="lang-bash">(Pdb) c
[...] # You will have to guess a number
The total value as of now is 0
&gt; /Users/Development/pdb-tutorial/dicegame/runner.py(17)answer()
-&gt; for die in self.dice:
(Pdb)
</code></pre>
<p>We see that out print statement executed upon reaching this breakpoint. Let’s <code>c(ontinue)</code> again and see what happens.</p>
<pre><code class="lang-bash">(Pdb) c
[...] 
The total value as of now is 1
&gt; /Users/Development/pdb-tutorial/dicegame/runner.py(17)answer()
-&gt; for die in self.dice:
(Pdb)
</code></pre>
<p>The <code>commands</code> command executes upon reaching the breakpoint again. You can see how this might be useful especially during loops.</p>
<h3 id="pdb-pm-Post-Mortem"><a href="#pdb-pm-Post-Mortem" class="headerlink" title="pdb.pm() Post Mortem"></a><code>pdb.pm()</code> Post Mortem</h3><pre><code>pdb.post_mortem(traceback=None)
    Enter post-mortem debugging of the given traceback object. If no traceback is given, it uses the one of the exception that is currently being handled
    (an exception must be being handled if the default is to be used).

pdb.pm()
    Enter post-mortem debugging of the traceback found in sys.last_traceback.
</code></pre><p>While both methods may look the same, <code>post_mortem() and pm()</code> differ by the traceback they are given. I commonly use <code>post_mortem()</code> in the <code>except</code> block. However, we will cover the <code>pm()</code> method since I find it to be a bit more powerful. Let’s try and see how this works in practice.</p>
<p>Open up the python REPL by typing <code>python</code> in your shell in the root of this project. From there, let’s import the <code>main</code> method from the <code>main</code> module and import <code>pdb</code> as well. Play the game until the we get the exception after trying to type <code>Y</code> to continue the game.</p>
<pre><code>&gt;&gt;&gt; import pdb
&gt;&gt;&gt; from main import main
&gt;&gt;&gt; main()
[...]
Would you like to play again?[Y/n]: Y
Traceback (most recent call last):
  File "main.py", line 12, in &lt;module&gt;
    main()
  File "main.py", line 8, in main
    GameRunner.run()
  File "/Users/Development/pdb-tutorial/dicegame/runner.py", line 62, in run
    i_just_throw_an_exception()
  File "/Users/Development/pdb-tutorial/dicegame/utils.py", line 13, in i_just_throw_an_exception
    raise UnnecessaryError("You actually called this function...")
dicegame.utils.UnnecessaryError: You actually called this function...
</code></pre><p>Now, let’s call the <code>pm()</code> method from the <code>pdb</code> module and see what happens.</p>
<pre><code>&gt;&gt;&gt; pdb.pm()
&gt; /Users/Development/pdb-tutorial/dicegame/utils.py(13)i_just_throw_an_exception()
-&gt; raise UnnecessaryError("You actually called this function...")
(Pdb)
</code></pre><p>Look at that! We recover from the point where the last exception was thrown and are placed in the <code>pdb</code> prompt. From here, we can examine the state the program was in before it crashed which will help you in your investigation.</p>
<p><strong>NB</strong>: You can also start the <code>main.py</code> script using <code>python -m pdb main.py</code> and <code>continue</code> until an exception is thrown. Python will automatically enter <code>post_mortem</code> mode at the uncaught exception.</p>
<p>links:<a target="_blank" rel="noopener" href="https://wil.yegelwel.com/pdb-pm/">https://wil.yegelwel.com/pdb-pm/</a></p>
<h4 id="Python-Debugging-How-to-use-pdb-pm"><a href="#Python-Debugging-How-to-use-pdb-pm" class="headerlink" title="Python Debugging: How to use pdb.pm()"></a>Python Debugging: How to use pdb.pm()</h4><p>Python’s debugger, <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/pdb.html">pdb</a>, is a great tool and one of my favorite uses of pdb is <code>pdb.pm()</code>. This post shows how to use <code>pdb.pm()</code> by working through an example of a buggy implementation of mergesort.</p>
<p><code>pdb.pm()</code> launches <code>pdb</code> to debug the most recently raised exception. When you find yourself saying “Shit! That exception occurred four layers deep in code I wasn’t editting and setting up the state to reproduce this is going to take 20 minutes” or “I wish I could just debug right from where the exception was raised”, <code>pdb.pm()</code> is what you want.</p>
<p>As a working example, consider the following implementation of mergesort. It isn’t great: the code has a logic bug, duplicates memory and suffers from array expansion, we will only focus on the logic bug.</p>
<pre><code class="lang-Python">def mergesort(xs): 
    if len(xs) == 1: 
        return xs 
    else: 
        left = mergesort(xs[:len(xs)//2]) 
        right = mergesort(xs[len(xs)//2:]) 
        ys = [] 
        left_i, right_i = 0, 0 
        while left_i &lt; len(left) or right_i &lt; len(right): 
            if left[left_i] &lt;= right[right_i]: 
                ys.append(left[left_i]) 
                left_i += 1 
            else: 
                ys.append(right[right_i]) 
                right_i += 1 
        return ys
</code></pre>
<p>The bug is in the while loop. If <code>left_i</code> is less than <code>len(left)</code> it will drop into the loop body, even if <code>right_i</code> is greater than or equal to <code>len(right)</code>. In that case, it will try to index out of the array bounds. Gasp!</p>
<p>If you try to use this code, you will get the error we expect.</p>
<pre><code class="lang-Python">In [2]: mergesort([6,5,4,3,2,1])                                                                                                                                                                                  
---------------------------------------------------------------------------
IndexError                                Traceback (most recent call last)
&lt;ipython-input-30-15081790cedb&gt; in &lt;module&gt;
----&gt; 1 mergesort([6,5,4,3,2,1])

&lt;ipython-input-28-cb4e97206eb8&gt; in mergesort(xs)
      3         return xs
      4     else:
----&gt; 5         left = mergesort(xs[:len(xs)//2])
      6         right = mergesort(xs[len(xs)//2:])
      7         ys = []

&lt;ipython-input-28-cb4e97206eb8&gt; in mergesort(xs)
      4     else:
      5         left = mergesort(xs[:len(xs)//2])
----&gt; 6         right = mergesort(xs[len(xs)//2:])
      7         ys = []
      8         left_i, right_i = 0, 0

&lt;ipython-input-28-cb4e97206eb8&gt; in mergesort(xs)
      8         left_i, right_i = 0, 0
      9         while left_i &lt; len(left) or right_i &lt; len(right):
---&gt; 10             if left[left_i] &lt;= right[right_i]:
     11                 ys.append(left[left_i])
     12                 left_i += 1

IndexError: list index out of range
</code></pre>
<p>While we already know what the bug is, we can use <code>pdb.pm()</code> to poke at the state to see what is going on. We can query for the state of variables to see what triggered the problem.</p>
<pre><code class="lang-Python">In [33]: import pdb; pdb.pm()                                                                                                                                                                                      
&gt; &lt;ipython-input-28-cb4e97206eb8&gt;(10)mergesort()
-&gt; if left[left_i] &lt;= right[right_i]:
(Pdb) left_i, right_i
(0, 1)
(Pdb) left
[5]
(Pdb) right
[4]
</code></pre>
<p>Ok, now we can see what happened. Both <code>left</code> and <code>right</code> had a single element but the code tried to index the non-existent second element in <code>right</code>.</p>
<p>If we needed to, we could step up the traceback to understand the state using the command <code>u</code> (for up). Then we can poke at the state higher in the stack as we did before.</p>
<pre><code class="lang-Python">(Pdb) u
&gt; &lt;ipython-input-28-cb4e97206eb8&gt;(6)mergesort()
-&gt; right = mergesort(xs[len(xs)//2:])
(Pdb) left
[6]
(Pdb) xs
[6, 5, 4]
(Pdb) xs[len(xs)//2:]
[5, 4]
</code></pre>
<p>Debugging exceptions becomes a lot easier once you become comfortable with <code>pdb.pm()</code>.</p>
</blockquote>
<p><strong>pycallgraph</strong></p>
<p><strong>graphviz</strong></p>
<pre><code class="lang-bash">pycallgraph graphviz script.py
</code></pre>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Turingzhi</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://turingzhi.github.io/2024/07/11/missing-semester-lecture7/">http://turingzhi.github.io/2024/07/11/missing-semester-lecture7/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint policy. If reproduced, please indicate source
                    <a href="/about" target="_blank">Turingzhi</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/debug/">
                                    <span class="chip bg-color">debug</span>
                                </a>
                            
                                <a href="/tags/profiling/">
                                    <span class="chip bg-color">profiling</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2024/08/15/algorithms-for-massive-datasets/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/14.jpg" class="responsive-img" alt="Algorithms for Massive Datasets">
                        
                        <span class="card-title">Algorithms for Massive Datasets</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-08-15
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/algorithm/" class="post-category">
                                    algorithm
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/algorithm/">
                        <span class="chip bg-color">algorithm</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/04/26/missing-semester-lecture6/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/10.jpg" class="responsive-img" alt="Missing Semester Lecture6: Version Control(git)">
                        
                        <span class="card-title">Missing Semester Lecture6: Version Control(git)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-04-26
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/missing-semester/" class="post-category">
                                    missing semester
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/git/">
                        <span class="chip bg-color">git</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'From: Hexo<br />'
            + 'Author: Turingzhi<br />'
            + 'Link: <a href="' + url + '">' + url + '</a><br />'
            + 'The copyright of this article belongs to the author. Please indicate the source for any reprint.';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2024</span>
            
            <a href="/about" target="_blank">Turingzhi</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;Total Words:&nbsp;<span
                        class="white-color">11.6k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;Total visits:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;Total visitors:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2024";
                        var startMonth = "4";
                        var startDate = "15";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);
                        var diffHours = Math.floor((diff /hours) - diffYears * 365 * 24 - diffDays * 24)
                        var diffMinutes = Math.floor((diff /minutes) - diffYears * 365 * 24 * 60 - diffDays * 24 * 60 - diffHours * 60)
                        var diffSeconds = Math.floor((diff /seconds) - diffYears * 365 * 24 * 60 * 60 - diffDays * 24 * 60 * 60 - diffHours * 60 * 60 - diffMinutes * 60)

                        // 区分是否有年份.
                        var language = 'en';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days ' + diffHours + ' hours ' + diffMinutes + ' minutes ' + diffSeconds + ' seconds';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                    setInterval("calcSiteTime()",1000);
                </script>
            
            <br>
            
        </div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/snow.js"><\/script>');
            }
        </script>
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
